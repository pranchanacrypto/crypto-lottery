name: Deploy Frontend to Pinata

on:
  push:
    branches: [main]
    paths: ['frontend/**']
  pull_request:
    paths: ['frontend/**']
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  deploy:
    name: Build and Deploy to IPFS
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ðŸ—ï¸ Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: ðŸ“Š Check build size
        run: |
          echo "Build size:"
          du -sh frontend/dist
          echo ""
          echo "Files:"
          ls -lah frontend/dist

      - name: ðŸŒ Upload to Pinata
        id: pinata
        working-directory: ./frontend/dist
        run: |
          # Create tarball of all files
          tar -czf ../dist.tar.gz .
          cd ..
          
          # Upload to Pinata
          RESPONSE=$(curl -X POST "https://api.pinata.cloud/pinning/pinFileToIPFS" \
            -H "pinata_api_key: ${{ secrets.PINATA_API_KEY }}" \
            -H "pinata_secret_api_key: ${{ secrets.PINATA_SECRET_KEY }}" \
            -F "file=@dist.tar.gz" \
            -F "pinataMetadata={\"name\":\"crypto-lottery-frontend-${{ github.sha }}\"}")
          
          echo "Pinata Response:"
          echo "$RESPONSE"
          
          # Extract CID from response
          CID=$(echo "$RESPONSE" | grep -o '"IpfsHash":"[^"]*' | cut -d'"' -f4)
          
          if [ -z "$CID" ]; then
            echo "Error: Failed to extract CID from Pinata response"
            exit 1
          fi
          
          echo "CID: $CID"
          echo "cid=$CID" >> $GITHUB_OUTPUT
          echo "url=https://gateway.pinata.cloud/ipfs/$CID" >> $GITHUB_OUTPUT
          
          # Clean up
          rm dist.tar.gz

      - name: ðŸ“ Create deployment summary
        if: success()
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**IPFS CID:** \`${{ steps.pinata.outputs.cid }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Access URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Pinata Gateway: ${{ steps.pinata.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— IPFS Gateway: https://ipfs.io/ipfs/${{ steps.pinata.outputs.cid }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Cloudflare Gateway: https://cloudflare-ipfs.com/ipfs/${{ steps.pinata.outputs.cid }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Info:**" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: [\#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ’¬ Comment on PR
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const cid = '${{ steps.pinata.outputs.cid }}';
            const url = '${{ steps.pinata.outputs.url }}';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸŒ Frontend Preview on IPFS
            
            **IPFS CID:** \`${cid}\`
            
            **Preview URLs:**
            - ðŸ”— [Pinata Gateway](${url})
            - ðŸ”— [IPFS Gateway](https://ipfs.io/ipfs/${cid})
            - ðŸ”— [Cloudflare Gateway](https://cloudflare-ipfs.com/ipfs/${cid})
            
            *Deployed from commit ${context.sha.substring(0, 7)}*`
            })

      - name: âŒ Deployment failed
        if: failure()
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Common issues:**" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid Pinata API credentials" >> $GITHUB_STEP_SUMMARY
          echo "- Build errors in frontend" >> $GITHUB_STEP_SUMMARY
          echo "- Network connectivity issues" >> $GITHUB_STEP_SUMMARY

